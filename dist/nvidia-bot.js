(()=>{"use strict";var e={233:function(e,t,n){var o=this&&this.__createBinding||(Object.create?function(e,t,n,o){void 0===o&&(o=n),Object.defineProperty(e,o,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,o){void 0===o&&(o=n),e[o]=t[n]}),i=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&o(t,e,n);return i(t,e),t},r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const s=r(n(358)),l=r(n(17)),c=n(349),d=a(n(394));t.default=class{constructor(){this.embedMessageQueue=[];const{DISCORD_TOKEN:e,DISCORD_CHANNEL_NAME:t}=process.env;e||(d.default.Log("DiscordClient","Missing Discord bot token",d.LogLevel.ERROR),process.exit(1)),t||(d.default.Log("DiscordClient","Missing Discord channel name",d.LogLevel.ERROR),process.exit(1)),this.token=e,this.channelName=t,this.client=new c.Client({intents:[c.Intents.FLAGS.GUILDS,c.Intents.FLAGS.GUILD_MESSAGES]})}get User(){return this.client?.user}Login(e){this.client&&(this.client.on("ready",(async()=>{d.default.Log("DiscordClient",`Signed in as ${this.client.user.tag}!`),this.SetRandomActivity(),setInterval(this.SetRandomActivity,72e5),"function"==typeof e&&e()})),d.default.Log("DiscordClient","Signing in to Discord..."),this.client.login(this.token))}QueueEmbeddedMessage(e,t,n={}){let o=(new Date).toLocaleString(process.env.LANG.split(".")[0].replace(/_/g,"-").toLowerCase());this.embedMessageQueue.push(new c.MessageEmbed({title:e,description:t,...n,footer:{text:n?.footer?.text?`${n?.footer?.text} â€¢ ${o}`:o}}))}SendEmbeddedMessage(e,t,n={}){if(!this.client)return;let o=(new Date).toLocaleString(process.env.LANG.split(".")[0].replace(/_/g,"-").toLowerCase());this.client.guilds.cache.each((i=>{let a=process.env.DISCORD_GUILDS?.split(/,|;/)||[];if(!a.length||""===a[0]||a.includes(i.id))try{const a=i.channels.cache.find((e=>e.name===process.env.DISCORD_CHANNEL_NAME));a?a.send({embeds:[new c.MessageEmbed({title:e,description:t,...n,footer:{text:n?.footer?.text?`${n?.footer?.text} â€¢ ${o}`:o}})]}):d.default.Log("DiscordClient",`The server "${i.name}" has no channel named "${this.channelName}".`,d.LogLevel.ERROR)}catch(e){d.default.Log("DiscordClient",`Failed to send message to "${i.name}". Error: ${e}`,d.LogLevel.ERROR)}}))}SendMessage(e){this.client&&this.client.guilds.cache.each((t=>{let n=process.env.DISCORD_GUILDS?.split(/,|;/)||[];if(!n.length||""===n[0]||n.includes(t.id))try{const n=t.channels.cache.find((e=>e.name===process.env.DISCORD_CHANNEL_NAME));n?n.send(e):d.default.Log("DiscordClient",`The server "${t.name}" has no channel named "${this.channelName}".`,d.LogLevel.ERROR)}catch(e){d.default.Log("DiscordClient",`Failed to send message to "${t.name}". Error: ${e}`,d.LogLevel.ERROR)}}))}SendQueuedEmbedMessages(){this.embedMessageQueue.length&&this.client&&(this.client.guilds.cache.each((e=>{let t=process.env.DISCORD_GUILDS?.split(/,|;/)||[];if(!t.length||""===t[0]||t.includes(e.id))try{const t=e.channels.cache.find((e=>e.name===process.env.DISCORD_CHANNEL_NAME));t?t.send({embeds:this.embedMessageQueue}):d.default.Log("DiscordClient",`The server "${e.name}" has no channel named "${this.channelName}".`,d.LogLevel.ERROR)}catch(t){d.default.Log("DiscordClient",`Failed to send message to "${e.name}". Error: ${t}`,d.LogLevel.ERROR)}})),this.embedMessageQueue=[])}SetRandomActivity(){try{let e=JSON.parse(s.default.readFileSync(l.default.join(process.cwd(),"activities.json")).toString()),t=e[Math.floor(Math.random()*e.length)];d.default.Log("DiscordClient",`Setting activity to [3m${t.options.type}[0m "${t.text}".`),this.client.user.setActivity(t.text,t.options)}catch(e){d.default.Log("DiscordClient",`Could not set user activity. Error: ${e}`,d.LogLevel.ERROR)}}}},505:function(e,t,n){var o=this&&this.__createBinding||(Object.create?function(e,t,n,o){void 0===o&&(o=n),Object.defineProperty(e,o,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,o){void 0===o&&(o=n),e[o]=t[n]}),i=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&o(t,e,n);return i(t,e),t},r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const s=r(n(167)),l=n(788),c=a(n(394)),d=r(n(356)),u=process.env.GPU_LIST.split(/,|;/);let f={"cs-cz":"CZK","da-dk":"EUR","de-at":"EUR","de-ch":"CHF","de-de":"EUR","en-au":"AUD","en-ca":"CAD","en-eu":"EUR","en-gb":"GBP","en-il":"EUR","en-in":"INR","en-me":"","en-sg":"SGD","en-us":"USD","es-es":"EUR","es-la":"","fi-fi":"EUR","fr-be":"EUR","fr-fr":"EUR","it-it":"EUR","jp-jp":"JPY","ko-kr":"KRW","nb-no":"NOK","nl-nl":"EUR","pl-pl":"PLN","pt-br":"BRL","ro-ro":"RON","ru-ru":"RUB","sv-se":"SEK","tr-tr":"TRN","zh-cn":"CNY","zh-tw":"TWD"};class h{static get ProductCache(){return this.productCache}static CheckProducts(e,t){let n=t.split("-")[1].toUpperCase();for(const o of e){let e=o.gpu,i=o.productAvailable,a=o.productSKU,r=o.productTitle;if(this.CurrentAvailability[n]||(this.CurrentAvailability[n]={}),this.CurrentAvailability[n][a]){let e=this.CurrentAvailability[n][a];e.productAvailable!=i&&c.default.Log("EdgeInventory",`(${n}) ${r}: Availability changed (${e.productAvailable} â†’ ${i})`);let s=Object.keys(e.retailers),d=o.retailers.map((e=>e.retailerName));s.filter((e=>!d.includes(e))).forEach((e=>{c.default.Log("EdgeInventory",`(${n}) ${r}: Retailer removed â€“ ${e}`),discordClient.SendEmbeddedMessage(`:flag_${n.toLowerCase()}: ${r}`,(0,l.sprintf)(Localization.RETAILER_REMOVED,e),{color:16302848})})),d.filter((e=>!s.includes(e))).forEach((e=>{c.default.Log("EdgeInventory",`(${n}) ${r}: Retailer added â€“ ${e}`),discordClient.SendEmbeddedMessage(`:flag_${n.toLowerCase()}: ${r}`,(0,l.sprintf)(Localization.RETAILER_ADDED,e),{color:16302848})}));for(const e of o.retailers){let o=e.retailerName,i=this.CurrentAvailability[n][a].retailers[o];if(i){if(Math.abs(i.salePrice-parseFloat(e.salePrice))>.001){let a=new Intl.NumberFormat(t,{style:"currency",currency:f[t]}).format(i.salePrice),s=new Intl.NumberFormat(t,{style:"currency",currency:f[t]}).format(e.salePrice);c.default.Log("EdgeInventory",`(${n}) ${r}: ${o} changed price (${a} â†’ ${s})`),discordClient.SendEmbeddedMessage(`:flag_${n.toLowerCase()}: ${r}`,(0,l.sprintf)(Localization.RETAILER_PRICE_CHANGE,o,a,s),{color:16302848})}i.stock!=e.stock&&(c.default.Log("EdgeInventory",`(${n}) ${r}: ${o} changed stock (${i.stock} â†’ ${e.stock})`),discordClient.SendEmbeddedMessage(`:flag_${n.toLowerCase()}: ${r}`,(0,l.sprintf)(Localization.RETAILER_STOCK_CHANGE,o,i.stock,e.stock),{color:16302848})),i.directPurchaseLink!=e.directPurchaseLink&&(c.default.Log("EdgeInventory",`(${n}) ${r}: ${r}: ${o} changed direct purchase link (${i.directPurchaseLink} â†’ ${e.directPurchaseLink})`),discordClient.SendEmbeddedMessage(`:flag_${n.toLowerCase()}: ${r}`,(0,l.sprintf)(Localization.RETAILER_URL_CHANGE,o,i.directPurchaseLink,e.directPurchaseLink),{color:16302848}))}}}else this.CurrentAvailability[n][a]={gpu:e,productAvailable:i,productSKU:a,productTitle:r,retailers:{}};for(const e of o.retailers){let t=e.retailerName;this.CurrentAvailability[n][a].retailers[t]={directPurchaseLink:e.directPurchaseLink,salePrice:parseFloat(e.salePrice),stock:e.stock}}break}}static async FetchProducts(){let e=process.env.LOCALES.split(/,|;/);await(0,d.default)(e,(async e=>{c.default.Log("EdgeInventory",`Fetching available products for locale "${e}"...`);try{let t=await s.default.get((0,l.sprintf)("https://api.nvidia.partners/edge/product/search?page=1&limit=9&locale=%s&category=GPU&gpu=%s&manufacturer=NVIDIA",e,u));t.data&&"failed"!==t.data||(Object.keys(this.productCache[e]).length?c.default.Log("EdgeInventory","Fetching product data failed. Using cached data instead.",c.LogLevel.WARN):c.default.Log("EdgeInventory","Fetching product data failed. No cached data available.",c.LogLevel.ERROR));let n=t.data.searchedProducts;if(!n)return;let o=n.featuredProduct,i=n.productDetails,a=[];a.push(o);for(const e of i)a.push(e);a.sort(((e,t)=>t.displayName.toLowerCase().localeCompare(e.displayName.toLowerCase()))),c.default.Log("EdgeInventory",`Fetched ${a.length} products for locale "${e}".`),this.productCache[e]=a,this.CheckProducts(a,e)}catch(e){c.default.Log("EdgeInventory",e,c.LogLevel.ERROR)}}))}}t.default=h,h.productCache={},h.CurrentAvailability={}},847:function(e,t,n){var o=this&&this.__createBinding||(Object.create?function(e,t,n,o){void 0===o&&(o=n),Object.defineProperty(e,o,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,o){void 0===o&&(o=n),e[o]=t[n]}),i=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&o(t,e,n);return i(t,e),t},r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.FEAvailability=void 0;const s=r(n(167)),l=n(788),c=r(n(505)),d=a(n(394)),u=r(n(356)),f=(process.env.GPU_LIST.split(/,|;/),["T060T","T070","T070T","T080","T080T","T090","T090T"]);let h={"en-gb":"UK"};var p;(p=t.FEAvailability||(t.FEAvailability={}))[p.CHECK_AVAILABILITY=29]="CHECK_AVAILABILITY",p[p.OUT_OF_STOCK=80]="OUT_OF_STOCK";class v{static get InventoryCache(){return this.inventoryCache}static async CheckInventory(){await this.FetchInventory();let e=process.env.LOCALES.split(/,|;/);for(const t of e){let e=h[t]??t.split("-")[1].toUpperCase();for(const n of this.inventoryCache[e]){let o="false"!==n.is_active,i=n.fe_sku,a=new URL(n.product_url),r=c.default.ProductCache[t].find((e=>e.productUPC===i));if(r)if(r.retailers.length)for(const t of r.retailers){let n=new URL(t.retailerName);this.CurrentInventory[e][n.hostname]||(this.CurrentInventory[e][n.hostname]={}),o?(console.log(t.productTitle,t.retailerName,t.type),d.default.Log("FEInventory",`(${e}) ${t.productTitle} available at ${a}`),this.CurrentInventory[e][n.hostname][i]||discordClient.QueueEmbeddedMessage(`:flag_${e.toLowerCase()}: ${t.productTitle}`,(0,l.sprintf)(Localization.PRODUCT_AVAILABLE,a),{color:53606,image:{url:r.imageURL},footer:{text:n}})):(d.default.Log("FEInventory",`(${e}) ${t.productTitle} out of stock at ${n}`),this.CurrentInventory[e][n.hostname][i]&&discordClient.QueueEmbeddedMessage(`:flag_${e.toLowerCase()}: ${t.productTitle}`,Localization.PRODUCT_NOT_AVAILABLE,{color:16580705,footer:{text:n}})),this.CurrentInventory[e][n.hostname][i]=!!o&&(this.CurrentInventory[e][n.hostname][i]||(new Date).getTime())}else d.default.Log("FEInventory",`(${e}) ${r.productTitle} does not have any retailers.`,d.LogLevel.ERROR)}}discordClient.SendQueuedEmbedMessages(),this.ScheduleNextCheck()}static async FetchInventory(){let e=process.env.LOCALES.split(/,|;/);await(0,u.default)(e,(async e=>{let t=h[e]??e.split("-")[1].toUpperCase();d.default.Log("FEInventory",`Fetching product availability for region "${t}"...`);try{await(0,u.default)(f,(async e=>{let n=await s.default.get((0,l.sprintf)("https://api.store.nvidia.com/partner/v1/feinventory?skus=NVGF%s&locale=%s",e,t));n.data&&"failed"!==n.data||(Object.keys(this.inventoryCache[t]).length,d.default.Log("FEInventory","Fetching inventory data failed. No cached data available."));var o=n.data.listMap.filter((e=>e.fe_sku.startsWith("NVGF")));o.length||d.default.Log("FEInventory",`Region ${t} does not sell Founders Edition GPUs via NVIDIA.`),this.inventoryCache[t]||(this.inventoryCache[t]=[]),this.inventoryCache[t].find((e=>e.fe_sku===o[0].fe_sku))?this.inventoryCache[t]=this.inventoryCache[t].map((e=>e.fe_sku===o[0].fe_sku?{...o[0]}:e)):this.inventoryCache[t]=this.inventoryCache[t].concat(o),this.CurrentInventory[t]||(this.CurrentInventory[t]={})}))}catch(e){d.default.Log("FEInventory",e,d.LogLevel.ERROR)}}))}static ScheduleNextCheck(){const{CHECK_INTERVAL:e,CHECK_INTERVAL_REDUCED:t,CHECK_INTERVAL_FOCUS:n,CHECK_INTERVAL_ACTIVE:o}=process.env,{CHECK_DAYS:i,FOCUS_DAYS:a,REDUCED_FOCUS_DAYS:r}=process.env,{CHECK_HOURS:s,CHECK_HOURS_FOCUS:l,CHECK_HOURS_REDUCED:c}=process.env;let u=Math.max(1,Number(e)||60),f=Math.max(1,Number(t)||300),h=Math.max(1,Number(n)||45),p=Math.max(1,Number(o)||20),v=i?.split(/,|;/).map((e=>parseInt(e))),g=a?.split(/,|;/).map((e=>parseInt(e))),L=r?.split(/,|;/).map((e=>parseInt(e))),m=s?.split(/,|;/).map((e=>e.split("-").map((e=>parseInt(e))))),C=l?.split(/,|;/).map((e=>e.split("-").map((e=>parseInt(e))))),E=c?.split(/,|;/).map((e=>e.split("-").map((e=>parseInt(e)))));clearTimeout(this.checkInterval),this.isActive=void 0!==Object.values(this.CurrentInventory).find((e=>Object.values(e).find((e=>Object.values(e).find((e=>!1!==e&&(new Date).getTime()-e<60*(parseInt(process.env.SALE_THRESHOLD)||15)*1e3))))));let y=(()=>{let e=new Date,t=e.getDay(),n=e.getHours();return this.isActive?(d.default.Log("FEInventory","Schedule next check for: [3mActive sale[0m"),p):g&&g.includes(t)?C?this.IsWithinTimespan(n,C)?(d.default.Log("FEInventory","Schedule next check for: [3mFocus Day â€“ Scheduled Hours[0m"),h):(d.default.Log("FEInventory","Schedule next check for: [3mFocus Day â€“ Regular Hours[0m"),u):(d.default.Log("FEInventory","Schedule next check for: [3mFocus Day[0m"),h):L&&L.includes(t)?E?this.IsWithinTimespan(n,E)?(d.default.Log("FEInventory","Schedule next check for: [3mReduced Focus Day â€“ Scheduled Hours[0m"),f):(d.default.Log("FEInventory","Schedule next check for: [3mReduced Focus Day â€“ Quiet Hours[0m"),1/0):(d.default.Log("FEInventory","Schedule next check for: [3mReduced Focus Day[0m"),f):v&&v.includes(t)||!v?m?this.IsWithinTimespan(n,m)?(d.default.Log("FEInventory","Schedule next check for: [3mScheduled Hours[0m"),u):(d.default.Log("FEInventory","Schedule next check for: [3mQuiet Hours[0m"),1/0):(d.default.Log("FEInventory","Schedule next check for: [3mDefault Interval[0m"),u):void 0})();!isNaN(y)&&isFinite(y)&&(d.default.Log("FEInventory",`Waiting ${y} seconds for next check.`),this.checkInterval=setTimeout((()=>{this.CheckInventory()}),1e3*y))}static IsWithinTimespan(e,t){for(const n of t)if(e>=n[0]||e<n[1])return!0;return!1}}t.default=v,v.isActive=!1,v.inventoryCache={},v.SKUMap={},v.CurrentInventory={}},394:(e,t)=>{var n;Object.defineProperty(t,"__esModule",{value:!0}),t.LogLevel=void 0,function(e){e[e.DEBUG=0]="DEBUG",e[e.INFO=1]="INFO",e[e.WARN=2]="WARN",e[e.ERROR=3]="ERROR",e[e.FATAL=4]="FATAL",e[e.HTTP=5]="HTTP"}(n=t.LogLevel||(t.LogLevel={})),t.default=class{static Log(e,t,i=n.INFO){console.log(`${o[i]} [${(new Date).toISOString()}] [[1m${e}[0m] ${t}`)}};const o={[n.DEBUG]:"[36m[DEBUG][0m",[n.INFO]:"[34m[INFO][0m",[n.WARN]:"[33m[WARN][0m",[n.ERROR]:"[31m[ERROR][0m",[n.FATAL]:"[41m[FATAL][0m",[n.HTTP]:"[32m[HTTP][0m"}},147:function(e,t,n){var o=this&&this.__createBinding||(Object.create?function(e,t,n,o){void 0===o&&(o=n),Object.defineProperty(e,o,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,o){void 0===o&&(o=n),e[o]=t[n]}),i=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&o(t,e,n);return i(t,e),t},r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const s=r(n(167)),l=r(n(358)),c=r(n(17)),d=r(n(521)),u=r(n(912)),f=r(n(505)),h=r(n(847)),p=r(n(233)),v=a(n(394));0==process.env.GPU_LIST.split(/,|;/).length&&(v.default.Log("EdgeInventory","No GPUs selected. At least one GPU needs to be selected.",v.LogLevel.ERROR),process.exit(1)),t.default=class{async Run(e){process.env={...process.env,LOCALES:e.locales??process.env.LOCALES,GPU_LIST:e.gpus??process.env.GPU_LIST,DISCORD_TOKEN:e.token??process.env.DISCORD_TOKEN,DISCORD_CHANNEL_NAME:e["channel-name"]??process.env.DISCORD_CHANNEL_NAME,DISCORD_GUILDS:e.guilds??process.env.DISCORD_GUILDS};let t=process.env.LOCALES.split(/,|;/)[0].split("-")[0].toLowerCase();l.default.existsSync(c.default.join(process.cwd(),"locale",`${t}.json`))?global.Localization=JSON.parse(l.default.readFileSync(c.default.join(process.cwd(),"locale",`${t}.json`)).toString()):global.Localization=JSON.parse(l.default.readFileSync(c.default.join(process.cwd(),"locale","en.json")).toString()),v.default.Log("NVIDIABot","Checking for available updates...");let n=JSON.parse(l.default.readFileSync(c.default.join(process.cwd(),"package.json")).toString()),o=await s.default.get("https://raw.githubusercontent.com/SniperGER/nvidia-bot/master/package.json").then((e=>e.data)).catch((e=>{v.default.Log("NVIDIABot",`Failed to check for updates: ${e.message}`,v.LogLevel.ERROR)}));n&&o&&(u.default.gt(o.version,n.version)?(v.default.Log("NVIDIABot",`A new version of ${n.name} is available! (Installed: ${n.version}, Current: ${o.version})`,v.LogLevel.WARN),v.default.Log("NVIDIABot",`Please visit ${n.homepage} for instructions on how to update.`,v.LogLevel.WARN)):v.default.Log("NVIDIABot","âœ… You're up to date!")),this.discordClient=new p.default,global.discordClient=this.discordClient,this.discordClient&&(this.discordClient.Login((async()=>{await f.default.FetchProducts(),await h.default.CheckInventory()})),d.default.createInterface({input:process.stdin,output:process.stdout}).on("SIGINT",(()=>{this.discordClient.User&&this.discordClient.User.setStatus("invisible"),v.default.Log("NVIDIABot","Goodbye!"),process.exit(0)})))}}},356:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.default=async(e,t)=>{for(let n=0;n<e.length;n++)await t(e[n],n)}},880:function(e,t,n){var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),n(294)(n(142).config({path:n(17).join(process.cwd(),".env")}));const i=o(n(167)),a=o(n(147));i.default.defaults.headers.common.Accept="application/json, text/plain, */*",i.default.defaults.headers.common["Accept-Encoding"]="gzip, deflate, br",i.default.defaults.headers.common["Cache-Control"]="no-cache",i.default.defaults.headers.common.Pragma="no-cache",(new a.default).Run(n(566)(process.argv.slice(2)))},167:e=>{e.exports=require("axios")},349:e=>{e.exports=require("discord.js")},142:e=>{e.exports=require("dotenv")},294:e=>{e.exports=require("dotenv-expand")},566:e=>{e.exports=require("minimist")},912:e=>{e.exports=require("semver")},788:e=>{e.exports=require("sprintf-js")},358:e=>{e.exports=require("fs")},17:e=>{e.exports=require("path")},521:e=>{e.exports=require("readline")}},t={},n=function n(o){var i=t[o];if(void 0!==i)return i.exports;var a=t[o]={exports:{}};return e[o].call(a.exports,a,a.exports,n),a.exports}(880);module.exports=n})();